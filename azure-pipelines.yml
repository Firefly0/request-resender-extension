# azure-pipelines.yml (excerpt)
trigger: none
pr: none

pool:
  vmImage: 'ubuntu-22.04'

steps:
  - bash: |
      set -euo pipefail
      echo "### Install tools"
      sudo apt-get update -yq
      sudo apt-get install -yq --no-install-recommends \
        curl jq traceroute nmap iproute2 dnsutils netcat-openbsd

      echo "### Discover host & gateway"
      ip -4 a | awk '/inet /{print $2}' | sed -n '1p' | tee artifacts/host-ip.txt
      ip -4 route | tee artifacts/routes.txt
      GW=$(ip route | awk '/default/ {print $3; exit}')
      HOST=$(hostname -I | awk '{print $1}')
      echo "Host IP: $HOST" | tee -a artifacts/local.txt
      echo "Gateway: $GW" | tee -a artifacts/local.txt

      echo "### Focused TCP scan (host + gw)"
      nmap -Pn -n -sT -p 22,80,443,445,3389,5000,8080,5432 "$HOST" "$GW" \
        | tee artifacts/scan.txt

      echo "### UDP quick probe (needs root)"
      sudo nmap -Pn -n -sU --top-ports 10 "$GW" | tee artifacts/udp-scan.txt || true

      echo "### IMDS non-secret probe (Azure style)"
      # instance metadata only; no token endpoints
      AZ_META=$(curl -s -H Metadata:true "http://169.254.169.254/metadata/instance?api-version=2021-02-01")
      echo "$AZ_META" | jq '.' > artifacts/imds-azure.json || true
      echo "subscriptionId: $(echo "$AZ_META" | jq -r '.compute.subscriptionId // "n/a"')" > artifacts/imds-azure.txt
      echo "resourceGroup:  $(echo "$AZ_META" | jq -r '.compute.resourceGroupName // "n/a"')" >> artifacts/imds-azure.txt
      echo "location:       $(echo "$AZ_META" | jq -r '.compute.location // "n/a"')" >> artifacts/imds-azure.txt

      echo "### Egress posture"
      {
        echo "http://example.com: $(curl -s -o /dev/null -w '%{http_code}' http://example.com)"
        echo "https://example.com: $(curl -s -o /dev/null -w '%{http_code}' https://example.com)"
        echo "https://ifconfig.me/ip -> $(curl -s https://ifconfig.me/ip || true)"
        echo "udp/53 (DNS) -> $(dig +short A example.com @1.1.1.1 | head -1 | sed 's/$/ (ok)/' || echo fail)"
        echo "udp/123 (NTP) -> $(timeout 2 nc -uzvw1 time.cloudflare.com 123 >/dev/null 2>&1 && echo ok || echo blocked)"
        echo "smtp.gmail.com:25 -> $(timeout 3 bash -c 'echo QUIT | nc -w2 smtp.gmail.com 25 >/dev/null 2>&1 && echo open || echo blocked')"
        echo "smtp.gmail.com:587 -> $(timeout 3 bash -c 'echo QUIT | nc -w2 smtp.gmail.com 587 >/dev/null 2>&1 && echo open || echo blocked')"
      } | tee artifacts/egress-posture.txt

      echo "### Traceroute (short, tcp/443) with sudo"
      sudo traceroute -n -T -p 443 -m 6 1.1.1.1 | tee artifacts/traceroute.txt || true

      echo "### Build run summary (markdown)"
      {
        echo "### SUMMARY ($(date -u +%FT%TZ))"
        echo
        echo "#### Azure IMDS highlights"
        sed 's/^/- /' artifacts/imds-azure.txt || true
        echo
        echo "#### Egress posture"
        sed 's/^/- /' artifacts/egress-posture.txt
        echo
        echo "#### Public IP"
        curl -s https://ifconfig.me/ip || true
        echo
        echo "#### Open ports (nmap summary)"
        grep -E 'open|filtered|closed' artifacts/scan.txt | sed 's/^/- /'
      } | tee artifacts/SUMMARY.md
    displayName: "Recon + fixed privileges"
  - publish: artifacts
    artifact: azure-recon-linux
